# Task: Success Stories — PDF Modal/Widget (Filters + Preview/Email/Download)

**Context**  
We previously had a Success Stories modal that showed **filters on the left** and a **full PDF viewer** (right, `public/successstories.pdf`).  
Filters come from a **hard-coded options list** (generated once by a script) and the **page filtering rules** come from `public/successstories-summary.csv`.  
Emailing and PDF filtering were handled by **Vercel serverless** functions. The code already exists — this task is to **rewire everything** in the new structure and make the PDF/email parts **modular for reuse** (the **Device Catalog** will use the same plumbing later).

> Do **not** change business logic; only integrate, refactor for reuse, fix imports/paths, and polish the UX as needed.

---

## Goals

1) Recreate the **Success Stories modal/widget**:
   - **Left panel**: multiselect filters (hard-coded options)
   - **Right panel**: **PDF viewer** showing `public/successstories.pdf` (full height of the modal)
   - Action buttons: **Preview**, **Email**, **Download**
2) Keep **filters + page mapping** driven by `public/successstories-summary.csv` (page ranges per option combo).
3) Use **Vercel serverless** to generate **filtered PDFs** and to **send emails** with the built PDF (or link).
4) Make all PDF + email code **modular/reusable** (so we can plug into **Catalog** later with minimal changes).
5) Update docs in `/docs` accordingly.

---

## Target Structure (add/move as needed)

```
src/
  components/
    shared/
      pdf/
        PDFBuilderModal.tsx                # already exists; extend for viewer mode
        PDFViewerPane.tsx                  # NEW: right-side viewer pane wrapper (pdf.js or <embed> fallback)
        actions.ts                         # wrappers for server actions (preview/download/email)
        index.ts
      panels/
        SuccessStoriesPanel.tsx            # left-side filters UI (reusable as panel or modal content)
        index.ts
      inputs/
        MultiSelect.tsx                    # already shared

  modules/
    success-stories/
      containers/
        SuccessStoriesPage.tsx             # full page using Panel + Modal (optional)
        SuccessStoriesWidget.tsx           # embeddable widget (modal-style UI)
      hooks/
        useSuccessStoriesFilters.ts        # state & derived selections
      services/
        successStories.service.ts          # CSV parsing, page mapping, caching
      types/
        successStories.types.ts
      index.ts

  lib/
    pdf/
      buildSuccessStoriesPdf.ts            # server-side helper that calls serverless endpoint
      emailPdf.ts                          # reusable email helper (Nodemailer SMTP)
      viewer.ts                            # helpers for viewer url, page params
    csv/
      parseCsv.ts                          # thin wrapper around Papa or custom parser
    utils/
      cache.ts                             # optional simple in-memory cache for CSV

app/
  intranet/
    success-stories/page.tsx               # renders SuccessStoriesPage (page wrapper)
    kiosk/
      successstories-embed/page.tsx        # renders SuccessStoriesWidget for kiosk
  api/
    pdf/
      success-stories/route.ts             # POST: {filters} -> filtered PDF (stream or URL)
  api/
    email/send/route.ts                    # POST: {to, subject, body, attachmentUrl?} with Nodemailer
public/
  successstories.pdf
  successstories-summary.csv
```

> If any of these files already exist, adapt/merge rather than duplicate. Keep **shared** pieces under `src/components/shared` and **feature** pieces under `src/modules/success-stories`.

---

## UI/UX Requirements

- Modal/Widget layout:
  - **Left**: `SuccessStoriesPanel` with multiselects (regions, years, systems, … as per current hard-coded options)
  - **Right**: `PDFViewerPane` that displays **either**:
    - the **base PDF** (`/successstories.pdf`), or
    - a **filtered preview** (URL returned by serverless preview)
- Buttons (top-right or below filters; keep consistent):
  - **Preview** → calls server action to generate a **temporary preview** PDF (in-memory or ephemeral storage) and updates the viewer to the preview URL.
  - **Download** → calls server action to generate a **downloadable** PDF; triggers browser download.
  - **Email** → opens a mini form (To/Subject optional; default to CONTACT_TO_EMAIL) → serverless email with link or attachment.
- Fallback when preview fails → show toast and keep base PDF.
- Keep the **builder-only approach** for final outputs; the **viewer** is for showing either base or preview URLs. We are **not** embedding a heavy annotation tool.

---

## Data & Filtering

- **Options**: use the existing **hard-coded options** source (generated by utility script). If needed, relocate it under `src/data/success-stories/options.ts` and export via a barrel.
- **Summary CSV**: `public/successstories-summary.csv` maps filters → page ranges (or list of pages).  
  - Implement `successStories.service.ts` to:
    - parse the CSV on first request,
    - compute page list for the current filters,
    - expose helpers: `getAvailableOptions()`, `getPagesForFilters(filters)`,
    - simple cache to avoid re-parsing on every request.
- **Filters hook**: `useSuccessStoriesFilters.ts` owns filter state and normalization.

---

## Serverless Endpoints (Vercel)

### 1) Build/Preview PDF
- **Route**: `POST /api/pdf/success-stories`
- **Body**: `{ filters, mode: "preview" | "download" }`
- **Output**:
  - For **preview**: return `{ url }` (a temporary URL that the viewer pane can load)
  - For **download**: stream the PDF response with appropriate `Content-Disposition` **or** return `{ url }` for client download
- **Implementation**:
  - Reuse existing PDF composition logic (don’t rewrite).  
  - If your previous code used Python or `pdf-lib`, keep that and invoke accordingly.  
  - Ensure it reads `pages = getPagesForFilters(filters)` from the service.
  - If using temporary storage, ensure the URL is accessible to the client for preview.

### 2) Send Email
- **Route**: `POST /api/email/send`
- **Body**: `{ to?: string, subject?: string, body?: string, attachmentUrl?: string, filters?: object }`
- **Behavior**:
  - If `attachmentUrl` not provided, build a **download** PDF first and attach or link.
  - Use **Nodemailer** with SMTP **App Password**.
  - Log minimal metadata (no PII) for debugging.

**Env Vars** (update `.env.example` & Vercel):
```env
# SMTP (App Password recommended)
SMTP_HOST=smtp.yourprovider.com
SMTP_PORT=465
SMTP_USER=your-user@example.com
SMTP_PASS=app-password-here

# Email defaults
CONTACT_FROM_EMAIL=your-user@example.com
CONTACT_TO_EMAIL=recipient@example.com
```

---

## Viewer Pane

- `PDFViewerPane.tsx` should prefer a **native `<embed>` or `<iframe>`** for simplicity, e.g.:
  ```tsx
  <embed src={`${url}#toolbar=0&navpanes=0`} type="application/pdf" className="w-full h-full" />
  ```
- If you already have **pdf.js** in the repo, you can use it; otherwise, keep it simple with `<embed>` for now.
- Add a loading/skeleton state when swapping to preview.

---

## Reuse for Catalog (Design for later)

- Place generic pieces in `src/components/shared/pdf` and `src/lib/pdf`.  
- Ensure serverless endpoints are **feature-agnostic** or trivially extendable:
  - e.g. `POST /api/pdf/build` with `{ feature: "success-stories" | "catalog", filters, mode }`
  - or keep separate routes but reuse shared build helpers.
- Keep `emailPdf.ts` generic (feature-agnostic).

---

## Wiring Steps (High Level)

1. **Move/confirm** the existing Success Stories code into the target structure above (no duplication).  
2. **Build the panel** (`SuccessStoriesPanel.tsx`) using the hard-coded options and wire it to `useSuccessStoriesFilters`.  
3. **Create the modal/widget** (Widget = modal-like container with left filters + right viewer).  
4. **Implement serverless** endpoints (build/preview + email) using existing logic.  
5. **Hook up actions** in `components/shared/pdf/actions.ts`:
   - `previewSuccessStories(filters) -> url`
   - `downloadSuccessStories(filters) -> url | stream`
   - `emailSuccessStories({ to?, subject?, filters }) -> { ok }`
6. **Render on routes**:
   - `/intranet/success-stories` uses `SuccessStoriesPage` (page wrapper)
   - `/intranet/kiosk/successstories-embed` uses `SuccessStoriesWidget`
7. **QA** with real CSV & PDF:
   - No filters → base PDF shows
   - With filters → preview shows correct pages
   - Download creates a file with correct pages
   - Email delivers (check spam)
   - Error states show toasts and degrade gracefully

---

## Acceptance Criteria

- Modal/widget shows **filters (left)** and **full PDF viewer (right)**.
- **Preview/Email/Download** actions work via **Vercel serverless**.
- Filters/options and page mapping from **hard-coded options + `successstories-summary.csv`**.
- PDF/email helpers are **modular** and can be reused for **Catalog**.
- Routes exist:
  - `/intranet/success-stories` (page wrapper)
  - `/intranet/kiosk/successstories-embed` (embed widget)
- `.env.example` includes the **SMTP** fields; Vercel envs set.
- Documentation updated in `/docs`:
  - **`README.md`**: brief note about Success Stories module & serverless actions
  - **`REPO_STRUCTURE.md`**: components/modules paths reflect final locations
  - **`DEVELOPMENT.md`**: how to run previews/downloads locally, env vars, test steps
  - **`ARCHITECTURE.md`**: diagram or paragraph linking Success Stories UI → serverless build/email

---

## Notes / Constraints

- Keep business logic and previous algorithms intact; the task is **wiring + modularization**.
- Use **PascalCase** for React component filenames.
- Use Tailwind tokens from `docs/TAILWIND_THEME.md`; no scattered hexes.
- Fail-safe: if preview build fails, keep base PDF in the viewer and show an error toast.
- Log serverless errors with minimal information (no PII).

---
